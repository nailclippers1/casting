<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>キャスティング投票結果</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; }
    /* サイドメニュー */
    .sidebar {
      width: 220px;
      background: #333;
      color: white;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    .sidebar h2 {
      font-size: 18px;
      margin-top: 0;
      border-bottom: 1px solid #555;
      padding-bottom: 10px;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
    }
    .sidebar li {
      margin: 10px 0;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 8px;
      border-radius: 4px;
    }
    .sidebar a:hover, .sidebar a.active {
      background: #555;
    }
    /* メイン */
    .main {
      flex: 1;
      padding: 20px;
    }
    .character {
      margin-bottom: 40px;
    }
    .character h3 {
      margin-bottom: 10px;
    }
    .ranking {
      margin-bottom: 20px;
    }
    .ranking li {
      margin: 5px 0;
    }
    canvas {
      max-width: 600px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- サイドバー -->
  <div class="sidebar">
    <h2>作品一覧</h2>
    <ul>
      <li><a href="#" class="active" onclick="loadResults('aim_for_the_ace')">エースをねらえ！</a></li>
      <li><a href="#" onclick="loadResults('glass_mask')">ガラスの仮面</a></li>
      <li><a href="#" onclick="loadResults('rose_of_versailles')">ベルサイユのばら</a></li>
      <!-- 以降、追加予定の作品もここに書き足す -->
    </ul>
  </div>

  <!-- メインコンテンツ -->
  <div class="main">
    <h1 id="workTitle">エースをねらえ！ キャスティング投票結果</h1>
    <div id="results"></div>
  </div>

  <!-- Chart.js 読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbwsbvfknvBvnS7qLXCOX0NBmoh5N8RyekiHqeStUTI9kWE7cMhv_ENi1c8zMBiIDC0-/exec";

    // 初期表示
    window.onload = () => {
      loadResults("aim_for_the_ace");
    };

    // 結果ロード関数
    function loadResults(workKey) {
      // サイドバー選択切り替え
      document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
      document.querySelector(`.sidebar a[onclick="loadResults('${workKey}')"]`).classList.add("active");

      // タイトル更新
      const workNames = {
        "aim_for_the_ace": "エースをねらえ！",
        "glass_mask": "ガラスの仮面",
        "rose_of_versailles": "ベルサイユのばら"
      };
      document.getElementById("workTitle").textContent = workNames[workKey] + " キャスティング投票結果";

      // データ取得
      fetch(scriptURL + "?action=summary&work=" + workKey)
        .then(res => res.json())
        .then(data => renderResults(data))
        .catch(err => {
          console.error(err);
          document.getElementById("results").innerHTML = "<p>集計データの取得に失敗しました。</p>";
        });
    }

    // 結果描画
    function renderResults(data) {
      const container = document.getElementById("results");
      container.innerHTML = "";

      Object.keys(data).forEach(character => {
        const votes = data[character];
        const sorted = Object.entries(votes).sort((a, b) => b[1] - a[1]); // 多い順

        // ランキング
        let rankingHTML = "<ol class='ranking'>";
        sorted.forEach(([actor, count]) => {
          rankingHTML += `<li>${actor} — ${count}票</li>`;
        });
        rankingHTML += "</ol>";

        // グラフ用データ
        const labels = sorted.map(([actor]) => actor);
        const counts = sorted.map(([_, count]) => count);

        const charDiv = document.createElement("div");
        charDiv.className = "character";
        charDiv.innerHTML = `<h3>${character}</h3>${rankingHTML}<canvas id="chart-${character}"></canvas>`;
        container.appendChild(charDiv);

        // 棒グラフ描画
        new Chart(document.getElementById(`chart-${character}`), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "投票数",
              data: counts,
              backgroundColor: "rgba(54, 162, 235, 0.6)"
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            }
          }
        });
      });
    }
  </script>
</body>
</html>
